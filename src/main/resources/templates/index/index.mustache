<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>Index Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body class="d-flex align-items-center justify-content-center" style="height: 100vh; background-color: #f8f9fa;">
<div class="card shadow-sm" style="width: 300px;">
    <div class="card-body text-center">
        <h5 class="card-title">Index Page</h5>
        <hr/>
        <div id="content">
            <!-- 여기에 동적으로 내용이 추가됩니다 -->
        </div>
    </div>
</div>

<!-- Toast 컴포넌트 추가 -->
<div class="toast-container position-fixed top-0 p-3">
    <div id="customToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- 오류 메시지가 여기에 표시됩니다 -->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let indexUserCheck = {
        timerInterval: null,
        accessToken: null,
        refreshToken: null,
        contentDiv: document.getElementById('content'),

        init() {
            this.loginCheck();
        },
        //최초 로그인 버튼 html
        contentLogin:`
                    <p>로그인이 필요합니다.</p>
                    <button type="button" class="btn btn-primary w-100" onclick="indexUserCheck.redirectToLogin()">Login</button>
                `,
        loginCheck() {
            this.accessToken = localStorage.getItem('accessToken');
            if (!this.accessToken) {
                // accessToken이 없을 때 로그인 페이지로 이동하는 버튼 제공
                this.contentDiv.innerHTML = this.contentLogin;
            } else {
                // accessToken이 있을 때 사용자 정보를 가져옴
                fetch('/api/v1/user/test', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + this.accessToken,
                        'Content-Type': 'application/json'
                    }
                })
                        .then(response => {
                            if (response.ok) {
                                return response.text();
                                //     } else if (response.status === 401) {
                                //         this.contentDiv.innerHTML = this.contentLogin;
                                //         return response.text().then((errorMessage) => {
                                //             localStorage.clear();
                                //             this.showToast(errorMessage);
                                //             throw new Error(errorMessage);
                                //         });
                                //     } else {
                                //         throw new Error('로그인이 필요합니다.');
                            }
                        })
                        .then(data => {
                            this.contentDiv.innerHTML = `<p>환영합니다, ${data}님!</p>
                        <p id="timer">30:00</p>
                        <button type="button" class="btn btn-warning w-100" onclick="indexUserCheck.logout()">Logout</button>
                        <button type="button" class="btn btn-success mt-2 w-100" onclick="indexUserCheck.updateAccessToken()">연장</button>
                    `;
                            this.initializeTimer();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
            }
        },

        redirectToLogin() {
            window.location.href = '/login';
        },

        logout() {
            fetch('/api/v1/user/logout', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + this.accessToken,
                    'Content-Type': 'application/json'
                }
            })
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        } else {
                            throw new Error('로그아웃 실패');
                        }
                    })
                    .then(data => {
                        if (data) {
                            this.showToast("로그아웃되었습니다.");
                            localStorage.clear();
                            clearInterval(indexUserCheck.timerInterval);
                            indexUserCheck.timerInterval = null;
                            this.loginCheck();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
        },

        updateAccessToken() {
            this.refreshToken = localStorage.getItem('refreshToken');
            fetch('/api/v1/user/refreshtoken', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + this.accessToken,
                    'Refresh-Token': this.refreshToken,
                    'Content-Type': 'application/json'
                }
            })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('토큰 갱신 실패');
                        }
                    })
                    .then(data => {
                        if (data) {
                            localStorage.setItem('accessToken', data.accessToken);
                            this.accessToken = data.accessToken;
                            this.showToast("토큰이 갱신되었습니다.");
                            this.initializeTimer();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
        },

        initializeTimer() {
            clearInterval(this.timerInterval); // 이전 타이머 중지
            indexUserCheck.timerInterval = null;

            const token = this.accessToken;
            if (!token) return;

            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = JSON.parse(atob(base64));

            const expirationTime = jsonPayload.exp * 1000;

            const updateTimer = () => {
                const currentTime = new Date().getTime();
                const timeLeft = expirationTime - currentTime;

                if (timeLeft <= 0) {
                    clearInterval(this.timerInterval);
                    localStorage.clear();
                    indexUserCheck.timerInterval = null;
                    this.contentDiv.innerHTML = this.contentLogin;
                    this.showToast("토큰이 만료되었습니다.");
                    return;
                }

                const minutes = Math.floor(timeLeft / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                document.getElementById('timer').textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            };

            this.timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        },

        showToast(message) {
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            const toastElement = new bootstrap.Toast(document.getElementById('customToast'));
            toastElement.show();
        }
    };

    document.addEventListener('DOMContentLoaded', () => indexUserCheck.init());
</script>
</body>
</html>
