<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>Index Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body class="d-flex align-items-center justify-content-center" style="height: 100vh; background-color: #f8f9fa;">
<div class="card shadow-sm" style="width: 300px;">
    <div class="card-body text-center">
        <h5 class="card-title">Index Page</h5>
        <hr/>
        <div id="content">
            <!-- 여기에 동적으로 내용이 추가됩니다 -->
        </div>
    </div>
</div>

<!-- Toast 컴포넌트 추가 -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="customToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- 오류 메시지가 여기에 표시됩니다 -->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', indexLoginCheck);

    let timerInterval;  // 타이머 인터벌을 전역에서 참조 가능하게 설정

    function indexLoginCheck() {
        const accessToken = localStorage.getItem('accessToken');
        const contentDiv = document.getElementById('content');

        if (!accessToken) {
            contentDiv.innerHTML = `
                <p>로그인이 필요합니다.</p>
                <button type="button" class="btn btn-primary w-100" onclick="redirectToLogin()">Login</button>
            `;
        } else {
            fetch('/api/v1/user/test', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }
            })
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        } else if (response.status === 401) {
                            contentDiv.innerHTML = `
                    <p>로그인이 필요합니다.</p>
                    <button type="button" class="btn btn-primary w-100" onclick="redirectToLogin()">Login</button>
                `;
                            return response.text().then((errorMessage) => {
                                localStorage.clear();
                                showToast(errorMessage);  // alert 대신 토스트로 메시지 표시
                                throw new Error(errorMessage); // 서버에서 반환한 메시지를 에러로 던짐
                            });
                        } else {
                            throw new Error('로그인이 필요합니다.');
                        }
                    })
                    .then(data => {
                        contentDiv.innerHTML = `<p>환영합니다, ${data}님!</p>
                    <p id="timer">30:00</p>
                    <button type="button" class="btn btn-warning w-100" onclick="logout()">Logout</button>
                    <button type="button" class="btn btn-success mt-2 w-100" onclick="updateAccessToken()">연장</button>
                `;
                        initializeTimer();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
        }
    }

    function redirectToLogin() {
        window.location.href = '/login'; // 로그인 페이지로 리다이렉트
    }

    function logout() {
        const accessToken = localStorage.getItem('accessToken');
        fetch('/api/v1/user/logout', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
            }
        })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error('로그아웃 실패');
                    }
                })
                .then(data => {
                    if (data) {
                        showToast("로그아웃되었습니다.");  // alert 대신 토스트로 메시지 표시
                        localStorage.clear();
                        indexLoginCheck();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
    }

    function updateAccessToken() {
        const accessToken = localStorage.getItem('accessToken');
        const refreshToken = localStorage.getItem('refreshToken');
        fetch('/api/v1/user/refreshtoken', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Refresh-Token': refreshToken,
                'Content-Type': 'application/json'
            }
        })
                .then(response => {
                    if (response.ok) {
                        return response.json();  // JSON 응답으로 받는다고 가정
                    } else {
                        throw new Error('토큰 갱신 실패');
                    }
                })
                .then(data => {
                    if (data) {
                        localStorage.setItem('accessToken', data.accessToken);
                        showToast("토큰이 갱신되었습니다.");  // alert 대신 토스트로 메시지 표시
                        initializeTimer();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
    }

    function initializeTimer() {
        clearInterval(timerInterval);  // 이전 타이머 중지

        const token = localStorage.getItem('accessToken');
        if (!token) return;

        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = JSON.parse(atob(base64));

        const expirationTime = jsonPayload.exp * 1000;

        function updateTimer() {
            const currentTime = new Date().getTime();
            const timeLeft = expirationTime - currentTime;

            if (timeLeft <= 0) {
                const contentDiv = document.getElementById('content');
                clearInterval(timerInterval);  // 타이머 중지
                localStorage.clear();
                contentDiv.innerHTML = `
                            <p>로그인이 필요합니다.</p>
                            <button type="button" class="btn btn-primary w-100" onclick="redirectToLogin()">Login</button>
                        `;
                showToast("토큰이 만료되었습니다.");  // alert 대신 토스트로 메시지 표시
                return;
            }

            const minutes = Math.floor(timeLeft / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            document.getElementById('timer').textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
        }

        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();
    }

    // Toast 표시 함수
    function showToast(message) {
        const toastMessage = document.getElementById('toastMessage');
        toastMessage.textContent = message;

        const toastElement = new bootstrap.Toast(document.getElementById('customToast'));
        toastElement.show();
    }
</script>
</body>
</html>
